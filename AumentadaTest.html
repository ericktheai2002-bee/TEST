<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización de Datos de Acciones</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
    <style>
        :root {
            --bg-primary: #121826;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --accent-primary: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --border-color: #4b5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        select, button {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover, button:hover {
            background-color: var(--bg-tertiary);
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin-bottom: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .volume-container {
            position: relative;
            height: 150px;
            margin-bottom: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 20px;
            font-weight: 600;
        }

        .positive {
            color: var(--accent-green);
        }

        .negative {
            color: var(--accent-red);
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Visualización de Datos de Acciones Intraday</h1>
            <div class="controls">
                <select id="symbol-selector">
                    <option value="">Cargando símbolos...</option>
                </select>
                <button id="reset-zoom">Reiniciar Zoom</button>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <h3>Precio Actual</h3>
                <p id="current-price">-</p>
            </div>
            <div class="stat-card">
                <h3>Cambio</h3>
                <p id="price-change">-</p>
            </div>
            <div class="stat-card">
                <h3>Volumen</h3>
                <p id="volume">-</p>
            </div>
            <div class="stat-card">
                <h3>Rango del Día</h3>
                <p id="day-range">-</p>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="candlestick-chart"></canvas>
        </div>

        <div class="volume-container">
            <canvas id="volume-chart"></canvas>
        </div>

        <div class="toolbar">
            <button id="zoom-in">Zoom +</button>
            <button id="zoom-out">Zoom -</button>
            <button id="pan-left">←</button>
            <button id="pan-right">→</button>
        </div>

        <footer>
            <p>Datos de: multi_stock_intraday_data.csv | Visualización creada con Chart.js</p>
        </footer>
    </div>

    <script>
        // Variables globales
        let candlestickChart, volumeChart;
        let allData = [];
        let currentSymbol = '';
        let currentData = [];

        // Configuración de colores para el modo oscuro
        Chart.defaults.color = '#d1d5db';
        Chart.defaults.borderColor = '#4b5563';

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        // Cargar datos desde GitHub
        async function loadData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ericktheai2002-bee/TEST/main/multi_stock_intraday_data.csv');
                const csvData = await response.text();
                parseCSVData(csvData);
            } catch (error) {
                console.error('Error cargando los datos:', error);
                alert('Error al cargar los datos. Verifique la consola para más detalles.');
            }
        }

        // Parsear datos CSV
        function parseCSVData(csvData) {
            const lines = csvData.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;
                
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                
                // Convertir a tipos de datos apropiados
                entry.open = parseFloat(entry.open);
                entry.high = parseFloat(entry.high);
                entry.low = parseFloat(entry.low);
                entry.fin = parseFloat(entry.fin);
                entry.volume = parseInt(entry.volume);
                
                // Crear objeto de fecha completo
                const dateStr = `${entry.fecha} ${entry.hora}:${entry.minuto}`;
                entry.timestamp = new Date(dateStr).getTime();
                
                allData.push(entry);
            }
            
            // Procesar datos y actualizar la interfaz
            populateSymbolSelector();
            updateSymbolData();
        }

        // Llenar el selector de símbolos
        function populateSymbolSelector() {
            const symbols = [...new Set(allData.map(item => item.symbol))].sort();
            const selector = document.getElementById('symbol-selector');
            
            selector.innerHTML = '';
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                selector.appendChild(option);
            });
            
            // Seleccionar el primer símbolo por defecto
            if (symbols.length > 0) {
                selector.value = symbols[0];
                currentSymbol = symbols[0];
                updateSymbolData();
            }
        }

        // Filtrar datos por símbolo seleccionado
        function updateSymbolData() {
            currentData = allData.filter(item => item.symbol === currentSymbol);
            currentData.sort((a, b) => a.timestamp - b.timestamp);
            
            updateCharts();
            updateStats();
        }

        // Actualizar gráficos
        function updateCharts() {
            updateCandlestickChart();
            updateVolumeChart();
        }

        // Actualizar gráfico de velas
        function updateCandlestickChart() {
            const ctx = document.getElementById('candlestick-chart').getContext('2d');
            
            // Destruir gráfico existente si hay uno
            if (candlestickChart) {
                candlestickChart.destroy();
            }
            
            // Preparar datos para el gráfico de velas
            const ohlcData = currentData.map(item => ({
                x: item.timestamp,
                o: item.open,
                h: item.high,
                l: item.low,
                c: item.fin
            }));
            
            // Crear el gráfico de velas
            candlestickChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: currentSymbol,
                        data: ohlcData,
                        color: {
                            up: '#10b981',
                            down: '#ef4444',
                            unchanged: '#9ca3af',
                        },
                        borderColor: '#00000000',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Apertura: ${point.o}`,
                                        `Máximo: ${point.h}`,
                                        `Mínimo: ${point.l}`,
                                        `Cierre: ${point.c}`
                                    ];
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'ctrl'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Actualizar gráfico de volumen
        function updateVolumeChart() {
            const ctx = document.getElementById('volume-chart').getContext('2d');
            
            // Destruir gráfico existente si hay uno
            if (volumeChart) {
                volumeChart.destroy();
            }
            
            // Preparar datos para el gráfico de volumen
            const volumeData = currentData.map(item => ({
                x: item.timestamp,
                y: item.volume,
                color: item.fin >= item.open ? '#10b981' : '#ef4444'
            }));
            
            // Crear el gráfico de volumen
            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'Volumen',
                        data: volumeData,
                        backgroundColor: volumeData.map(item => item.color),
                        borderColor: volumeData.map(item => item.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'ctrl'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        },
                        y: {
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    }
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
            
            // Sincronizar los zoom/pan entre gráficos
            candlestickChart.options.scales.x.min = volumeChart.options.scales.x.min;
            candlestickChart.options.scales.x.max = volumeChart.options.scales.x.max;
        }

        // Actualizar estadísticas
        function updateStats() {
            if (currentData.length === 0) return;
            
            const latest = currentData[currentData.length - 1];
            const previous = currentData.length > 1 ? currentData[currentData.length - 2] : latest;
            
            // Precio actual
            document.getElementById('current-price').textContent = latest.fin.toFixed(2);
            
            // Cambio de precio
            const change = latest.fin - previous.fin;
            const changePercent = (change / previous.fin) * 100;
            const changeElement = document.getElementById('price-change');
            changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
            changeElement.className = change >= 0 ? 'positive' : 'negative';
            
            // Volumen
            document.getElementById('volume').textContent = formatVolume(latest.volume);
            
            // Rango del día
            const dayHigh = Math.max(...currentData.map(item => item.high));
            const dayLow = Math.min(...currentData.map(item => item.low));
            document.getElementById('day-range').textContent = `${dayLow.toFixed(2)} - ${dayHigh.toFixed(2)}`;
        }

        // Formatear volumen para mostrar
        function formatVolume(volume) {
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            }
            if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return volume;
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Selector de símbolo
            document.getElementById('symbol-selector').addEventListener('change', function() {
                currentSymbol = this.value;
                updateSymbolData();
            });
            
            // Botones de zoom y pan
            document.getElementById('reset-zoom').addEventListener('click', function() {
                if (candlestickChart) {
                    candlestickChart.resetZoom();
                }
                if (volumeChart) {
                    volumeChart.resetZoom();
                }
            });
            
            document.getElementById('zoom-in').addEventListener('click', function() {
                if (candlestickChart) {
                    candlestickChart.zoom(1.1);
                }
            });
            
            document.getElementById('zoom-out').addEventListener('click', function() {
                if (candlestickChart) {
                    candlestickChart.zoom(0.9);
                }
            });
            
            document.getElementById('pan-left').addEventListener('click', function() {
                if (candlestickChart) {
                    // Implementar pan a la izquierda
                    const xScale = candlestickChart.scales.x;
                    const range = xScale.max - xScale.min;
                    candlestickChart.options.scales.x.min = xScale.min - range * 0.2;
                    candlestickChart.options.scales.x.max = xScale.max - range * 0.2;
                    candlestickChart.update();
                    
                    // Sincronizar con el gráfico de volumen
                    if (volumeChart) {
                        volumeChart.options.scales.x.min = candlestickChart.options.scales.x.min;
                        volumeChart.options.scales.x.max = candlestickChart.options.scales.x.max;
                        volumeChart.update();
                    }
                }
            });
            
            document.getElementById('pan-right').addEventListener('click', function() {
                if (candlestickChart) {
                    // Implementar pan a la derecha
                    const xScale = candlestickChart.scales.x;
                    const range = xScale.max - xScale.min;
                    candlestickChart.options.scales.x.min = xScale.min + range * 0.2;
                    candlestickChart.options.scales.x.max = xScale.max + range * 0.2;
                    candlestickChart.update();
                    
                    // Sincronizar con el gráfico de volumen
                    if (volumeChart) {
                        volumeChart.options.scales.x.min = candlestickChart.options.scales.x.min;
                        volumeChart.options.scales.x.max = candlestickChart.options.scales.x.max;
                        volumeChart.update();
                    }
                }
            });
        }
    </script>
</body>
</html>
